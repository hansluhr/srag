library(tidyverse)

#Declaração da pasta raiz
here::i_am("Rotinas/analise_srag.R")

#Importação da base
load(paste0(dirname(getwd()),"/bases/srag/Rdata/srag.RData"))


#Importação da tabela de municípios
readxl::read_excel("C:/Users/gabli/Desktop/Projetos/SIS/Bases Gerais/munics.xlsx" ) |>
  
  filter(code_muni %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) ) |>
  #Painel de municípios
  crossing(
    ano_mes = seq(zoo::as.yearmon("2015-01"), zoo::as.yearmon("2025-12"), by = 1/12) ) -> munics




munics |> 
  
  left_join(x = _, y = 

#Notificações
srag |>
  
  #Municípios de interesse
  filter(co_mun_res %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) ) |>
  
  count(ano_mes_notf,co_mun_res, name = "n_notificacoes") |> as_tibble(), 

  by = join_by("code_muni" == "co_mun_res", "ano_mes" == "ano_mes_notf") )  |>
  

left_join(x = _, y =    


#Internações em hospital
srag |>
  #Municípios de interesse
  filter(co_mun_res %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) & hospital == 1) |>
  
  count(ano_mes_notf,co_mun_res, name = "n_hospital") |> as_tibble(), 

  by = join_by("code_muni" == "co_mun_res", "ano_mes" == "ano_mes_notf") )  |>

left_join(x = _,  y = 
#Internações em UTI
srag |>
  #Municípios de interesse
  filter(co_mun_res %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) & uti == 1) |>
  
  count(ano_mes_notf,co_mun_res, name = "n_uti") |> as_tibble(), 

by = join_by("code_muni" == "co_mun_res", "ano_mes" == "ano_mes_notf") )  |>

left_join(x = _, y = 
#Evolução Cura
srag |>
  #Municípios de interesse
  filter(co_mun_res %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) & evolucao == 1) |>
  
  count(ano_mes_notf,co_mun_res, name = "n_evo_cura") |> as_tibble(), 

  by = join_by("code_muni" == "co_mun_res", "ano_mes" == "ano_mes_notf") )  |>

left_join(x = _, y =
#Evolução Óbito
srag |>
  #Municípios de interesse
  filter(co_mun_res %in% c(
    "355030", "330455", "530010", "230440", "292740", "310620", "130260", "410690", 
    "261160", "520870", "150140", "431490", "351880", "350950", "211130", "270430", 
    "500270", "330490", "221100", "250750", "330170", "330350", "354870", "240810", 
    "354780", "355220", "317020", "353440", "354340", "354990", "510340", "260790", 
    "420910", "291080", "311860", "280030", "420540", "411370", "320500", "313670", 
    "520140", "330100", "330045", "110020", "330330", "150080", "320520", "354980", 
    "160030", "140010", "430510", "353060", "330510", "352590", "250400", "353870", 
    "314330", "310670", "411520", "354850", "352940", "520110", "261110", "260410", 
    "351380" ) & evolucao == 2) |>
  
  count(ano_mes_notf,co_mun_res, name = "n_evo_obito") |> as_tibble(), 

by = join_by("code_muni" == "co_mun_res", "ano_mes" == "ano_mes_notf") ) -> base



base |>
  
  mutate(
    
  across(.cols = where(is.numeric), 
         
         .fns = ~ replace_na(., 0) ) ) |> 
  rio::export(x = _, "base_srag.xlsx")



seria bom pegar esses dados e montar uma base com o seguinte formato
Muncipio
Mês/Ano
Qtd Notificações
Qtd Internações
Qtd Evoluções para 1 - CURA
Qtd Evoluções para 2 - Óbito
